<?php

namespace App\Commands;

use App\Services\GitHubService;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Process;
use Illuminate\Support\Facades\Redis;
use LaravelZero\Framework\Commands\Command;
use Prism\Prism\Enums\Provider;
use Prism\Prism\Facades\Prism;

class TriageListenCommand extends Command
{
    protected $signature = 'triage:listen';

    protected $description = 'Listen for new GitHub issues via Redis pub/sub and post AI triage plans';

    public function handle(GitHubService $github): void
    {
        $this->info('Subscribing to bifrost.github channel...');

        Redis::subscribe(['bifrost.github'], function (string $message) use ($github) {
            $event = json_decode($message, true);

            if (! $event) {
                return;
            }

            $handler = $this->resolveHandler($event);

            if ($handler === null) {
                return;
            }

            $handler($event, $github);
        });
    }

    protected function resolveHandler(array $event): ?\Closure
    {
        $eventType = $event['eventType'] ?? null;
        $action = $event['payload']['action'] ?? null;

        $handlers = [
            'issues.opened' => fn (array $e, GitHubService $g) => $this->handleIssueOpened($e, $g),
            'pull_request.closed' => fn (array $e, GitHubService $g) => $this->handlePullRequestClosed($e),
        ];

        $key = "{$eventType}.{$action}";

        return $handlers[$key] ?? null;
    }

    protected function handleIssueOpened(array $event, GitHubService $github): void
    {
        $payload = $event['payload'];
        $repo = $payload['repository']['full_name'];
        $issue = $payload['issue'];

        $this->info("Triaging issue #{$issue['number']}: {$issue['title']}");

        $plan = $this->generatePlan($issue);

        $comment = "## ðŸ¤– Triage Agent\n\n{$plan}\n\n---\n*Generated by triage-agent via ".config('services.ollama.model').'*';

        $github->postComment($repo, $issue['number'], $comment);

        $this->info("Posted triage comment on {$repo}#{$issue['number']}");
    }

    protected function handlePullRequestClosed(array $event): void
    {
        $payload = $event['payload'];
        $pr = $payload['pull_request'] ?? null;

        if (! $pr || ! ($pr['merged'] ?? false)) {
            return;
        }

        $repo = $payload['repository']['full_name'] ?? 'unknown/repo';
        $number = $pr['number'] ?? 0;
        $title = $pr['title'] ?? 'Untitled PR';
        $body = $pr['body'] ?? '';
        $branch = $pr['head']['ref'] ?? 'unknown';
        $author = $pr['user']['login'] ?? 'unknown';
        $mergedAt = $pr['merged_at'] ?? now()->toIso8601String();

        $this->info("Capturing merged PR #{$number}: {$title}");

        $content = "PR #{$number} merged into {$repo}.\n\nBranch: {$branch}\nAuthor: {$author}\nMerged: {$mergedAt}";
        if ($body !== '') {
            $content .= "\n\nDescription:\n{$body}";
        }

        $result = Process::run([
            'know', 'add', "PR #{$number}: {$title}",
            '--content', $content,
            '--category', 'architecture',
            '--tags', "pr-merge,{$repo}",
            '--source', $pr['html_url'] ?? '',
            '--repo', $repo,
            '--branch', $branch,
            '--author', $author,
            '--status', 'validated',
            '--confidence', '80',
            '--no-git',
        ]);

        if ($result->successful()) {
            $this->info("Knowledge entry created for PR #{$number}");
        } else {
            $this->error("Failed to create knowledge entry: {$result->errorOutput()}");
            Log::error("know CLI failed for PR #{$number}: {$result->errorOutput()}");
        }
    }

    protected function shouldProcess(?array $event): bool
    {
        if (! $event) {
            return false;
        }

        return $this->resolveHandler($event) !== null;
    }

    protected function generatePlan(array $issue): string
    {
        $systemPrompt = <<<'PROMPT'
You are a senior software engineer triaging a new GitHub issue.
Analyze the issue and provide a concise implementation plan.

Respond with a markdown implementation plan including:
- Summary of what needs to be done
- Suggested approach (2-4 steps)
- Key files or areas likely affected
- Potential risks or considerations

Keep it actionable and concise.
PROMPT;

        $userMessage = "Issue: {$issue['title']}\n\n{$issue['body']}";

        $response = Prism::text()
            ->using(Provider::Ollama, config('services.ollama.model'))
            ->withSystemPrompt($systemPrompt)
            ->withPrompt($userMessage)
            ->withClientOptions(['timeout' => 120])
            ->asText();

        return $response->text;
    }
}
